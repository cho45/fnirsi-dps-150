# FNIRSI DPS-150 Communication Protocol – Practical Findings

This document summarizes **verified communication details of the FNIRSI DPS-150 programmable power supply**, obtained by sniffing USB/Serial traffic generated by the official Windows application **“FNIRSI Power supply.exe”**.

The purpose of this document is to **complete and clarify the protocol description**, enabling **full device control (not only monitoring)**.

All information below has been validated on real DPS-150 hardware.

---

## Transport Layer

- Interface: USB CDC (Virtual COM Port)
- Default baudrate: **115200**
- Data format: **8N1**
- Flow control: none

---

## Frame Structure

All protocol messages follow the structure:

```
START | CMD | TYPE | LEN | DATA... | CHECKSUM
```

### Direction

- `0xF1` – Host (PC) → DPS-150
- `0xF0` – DPS-150 → Host (telemetry / responses)

### Checksum

Checksum is calculated as:

```
checksum = (TYPE + LEN + sum(DATA bytes)) mod 256
```

This rule has been verified for all `C1` and `B1` commands (handshake, voltage set, output enable).

---

## Mandatory Initialization Sequence (Critical)

The DPS-150 **does not accept SET commands unless the following initialization sequence is executed**.

### 1. Enable / Handshake

```
F1 C1 00 01 01 02
```

Meaning:
- `CMD = C1` – connection control
- `TYPE = 00`
- `LEN = 01`
- `DATA = 0x01` → enable communication

Typical device response:

```
F1 A1 E1 01 00 E2
```

---

### 2. Start Telemetry Stream

```
F1 B0 00 01 01 01
```

Meaning:
- `CMD = B0` – start telemetry streaming
- After this command, the DPS-150 begins sending periodic telemetry frames (`F0 A1 ...`).

> Without this step, the device may remain silent even after a successful handshake.

---

## Device Identification Frames (RX)

After initialization, the device sends identification information:

| TYPE | Description      | Example |
|------|------------------|---------|
| `DE` | Device name      | DPS-150 |
| `E0` | Firmware version | V1.2    |
| `DF` | Hardware version | V1.0    |

---

## Telemetry Frames (RX)

### Measured Values

**TYPE `C3`, LEN `0x0C` (12 bytes)**

```
F0 A1 C3 0C [V float32] [I float32] [P float32] [CHK]
```

All values are **float32 little-endian**:

- Voltage (V)
- Current (A)
- Power (W)

This mapping was confirmed by correlation with real-time measurements.

---

## SET Commands (Confirmed by Sniffing)

### Set Output Voltage

```
F1 B1 C1 04 [float32 LE] [CHK]
```

Examples:

**Set 5.0 V**
```
F1 B1 C1 04 00 00 A0 40 A5
```

**Set 12.0 V**
```
F1 B1 C1 04 00 00 40 41 C6
```

Meaning:
- `CMD = B1` – set parameter
- `TYPE = C1` – voltage setpoint
- `DATA = float32 little-endian`

---

### Output Enable / Disable

**Output ON**
```
F1 B1 DB 01 01 DD
```

**Output OFF**
```
F1 B1 DB 01 00 DC
```

Meaning:
- `CMD = B1`
- `TYPE = DB` – output enable
- `DATA = 1` → ON
- `DATA = 0` → OFF

---

## Proper Shutdown Sequence

To close the communication session cleanly:

```
F1 C1 00 01 00 01
```

Meaning:
- `DATA = 0x00` → disable communication

---

## Behavioral Notes

- The DPS-150 uses a **stream-oriented protocol**, not strict request/response.
- Telemetry is sent **periodically** once streaming is enabled.
- SET commands (`B1`) do **not return explicit ACK frames**.
- Confirmation of SET operations must be derived from telemetry (`C3`, etc.).
- Sending SET commands without prior `C1 enable` and `B0 start stream` has no effect.

---

## Summary of Previously Missing Information

The following protocol elements were **not documented or incomplete** before sniffing:

- Mandatory handshake (`C1 enable`)
- Stream activation (`B0`)
- Voltage set command (`B1 C1`)
- Output ON/OFF command (`B1 DB`)
- Proper shutdown sequence (`C1 disable`)

These elements are essential for **actual DPS-150 control**, not just monitoring.

---

## Closing Note

All information in this document was obtained by analyzing real USB/Serial communication between the official FNIRSI Windows software and a DPS-150 unit.

Including these details should significantly improve the completeness and practical usability of this repository.
